{% extends 'base.html' %}
{% load rh_filters %}
{% load tz %}


{% block title %}Marcar Presença - HR Manager Pro{% endblock %}

{% block content %}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h1><i class="bi bi-clock-fill"></i> Marcar Presença</h1>
            <p class="mb-0">Data atual: <strong class="text-primary" id="data-atual">{{ data_atual|date:"d/m/Y" }}</strong></p>
            <p class="mb-0">Hora atual: <strong class="text-primary" id="hora-atual">{{ agora|date:"H:i:s" }}</strong></p>
        </div>
        <div class="col-auto">
            <a href="{% url 'faltas_do_dia' %}" class="btn btn-warning">
                <i class="bi bi-exclamation-triangle"></i> Faltas do Dia
            </a>
        </div>
    </div>
</div>

<!-- Formulário de Marcação -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Marcar Ponto</h5>
    </div>
    <div class="card-body">
        <form method="post" id="form-presenca">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    {{ form.funcionario }}
                </div>
                <div class="col-md-3">
                    <button type="submit" name="tipo_marcacao" value="entrada" class="btn btn-success w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Marcar Entrada
                    </button>
                </div>
                <div class="col-md-3">
                    <button type="submit" name="tipo_marcacao" value="saida" class="btn btn-danger w-100">
                        <i class="bi bi-box-arrow-left"></i> Marcar Saída
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Funcionários -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-people"></i> Funcionários</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Funcionário</th>
                        <th>Turno</th>
                        <th>Entrada</th>
                        <th>Saída</th>
                        <th>Horas Trabalhadas</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for funcionario in funcionarios %}
                    {% with presenca=presencas_dict|get_item:funcionario.id %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                {% if funcionario.foto %}
                                    <img src="{{ funcionario.foto.url }}" alt="{{ funcionario.nome_completo }}" class="rounded-circle me-2" width="40" height="40">
                                {% else %}
                                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
                                        {{ funcionario.nome_completo|first }}
                                    </div>
                                {% endif %}
                                <div>
                                    <strong>{{ funcionario.nome_completo }}</strong>
                                    <br><small class="text-muted">{{ funcionario.matricula }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if funcionario.turno %}
                                <span class="badge bg-info">{{ funcionario.turno.nome }}</span>
                                <br><small class="text-muted">{{ funcionario.turno.horas_diarias }}h/dia</small>
                            {% else %}
                                <span class="badge bg-secondary">Não definido</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if presenca and presenca.hora_entrada %}
                                <span class="text-success">{{ presenca.hora_entrada|date:"H:i" }}</span>
                            {% else %}
                                <span class="text-muted">--:--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if presenca and presenca.hora_saida %}
                                <span class="text-danger">{{ presenca.hora_saida|date:"H:i" }}</span>
                            {% else %}
                                <span class="text-muted">--:--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if presenca %}
                                <strong class="text-primary">{{ presenca.horas_trabalhadas }}h</strong>
                                {% if presenca.horas_faltantes > 0 %}
                                    <br><small class="text-warning">Faltam {{ presenca.horas_faltantes }}h</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">--</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if presenca %}
                                <span class="badge bg-{% if presenca.status == 'Presente' %}success{% elif presenca.status == 'Falta' %}danger{% elif presenca.status == 'Falta_Justificada' %}warning{% else %}secondary{% endif %}">
                                    {{ presenca.get_status_display }}
                                </span>
                            {% else %}
                                <span class="badge bg-secondary">Sem Registro</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Atualizar hora a cada segundo
function atualizarHora() {
    const agora = new Date();
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    document.getElementById('hora-atual').textContent = horaFormatada;
}

// Atualizar a cada segundo
setInterval(atualizarHora, 1000);

// Adicionar evento de submit ao formulário
document.getElementById('form-presenca').addEventListener('submit', function(e) {
    const funcionarioSelect = document.querySelector('select[name="funcionario"]');
    if (!funcionarioSelect.value) {
        e.preventDefault();
        alert('Por favor, selecione um funcionário!');
        return false;
    }
});
</script>
{% endblock %}