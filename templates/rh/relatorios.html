{% extends 'base.html' %}

{% block title %}Relatórios - HR Manager Pro{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-graph-up"></i> Relatórios</h1>
    <p>Visualize estatísticas e exporte dados da sua empresa</p>
</div>

<!-- Estatísticas Principais -->
<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number">{{ total_funcionarios }}</div>
            <div class="stat-label">Funcionários Ativos</div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number text-success">MZN {{ total_folha|floatformat:2 }}</div>
            <div class="stat-label">Total Folha (Mês Atual)</div>
        </div>
    </div>
    
    <div class="col-md-4 mb-3">
        <div class="stat-card text-center">
            <div class="stat-number text-info">
                MZN {% if total_funcionarios > 0 %}{{ media_salarial|floatformat:2 }}{% else %}0.00{% endif %}
            </div>
            <div class="stat-label">Média Salarial</div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row">
    <!-- Top Departamentos -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Departamentos com Mais Funcionários</h5>
            </div>
            <div class="card-body">
                <canvas id="topDeptChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Média Salarial por Departamento -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Média Salarial por Departamento</h5>
            </div>
            <div class="card-body">
                <canvas id="salaryChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Exportação de Dados -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-download"></i> Exportação de Dados</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="d-grid">
                    <a href="{% url 'funcionario_list' %}?export=excel" class="btn btn-primary">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Funcionários
                    </a>
                </div>
                <p class="text-muted small mt-2">Exporta todos os funcionários para Excel</p>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="d-grid">
                    <a href="{% url 'folha_pagamento_list' %}?export=excel" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Folha de Pagamento
                    </a>
                </div>
                <p class="text-muted small mt-2">Exporta todas as folhas de pagamento para Excel</p>
            </div>
            
            <div class="col-md-4 mb-3">
                <div class="d-grid">
                    <a href="{% url 'ferias_list' %}?export=excel" class="btn btn-info">
                        <i class="bi bi-file-earmark-excel"></i> Exportar Férias
                    </a>
                </div>
                <p class="text-muted small mt-2">Exporta todos os registros de férias para Excel</p>
            </div>
        </div>
    </div>
</div>

<!-- Análises Detalhadas -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Análises Detalhadas</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Top 5 Departamentos</h6>
                <div class="list-group list-group-flush">
                    {% for dept in top_departamentos %}
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>{{ dept.nome }}</span>
                            <span class="badge bg-primary">{{ dept.total }} funcionários</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="col-md-6">
                <h6>Média Salarial por Departamento</h6>
                <div class="list-group list-group-flush">
                    {% for dept in media_salarios %}
                        <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <span>{{ dept.nome }}</span>
                            <span class="badge bg-success">R$ {{ dept.media_salario|floatformat:2 }}</span>
                        </div>
                    {% empty %}
                        <p class="text-muted">Nenhum dado disponível</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gráfico de Top Departamentos
const topDeptCtx = document.getElementById('topDeptChart').getContext('2d');
const topDeptData = {
    labels: [{% for dept in top_departamentos %}'{{ dept.nome }}',{% endfor %}],
    datasets: [{
        label: 'Funcionários',
        data: [{% for dept in top_departamentos %}{{ dept.total }},{% endfor %}],
        backgroundColor: [
            '#6B46C1',
            '#8B5CF6',
            '#A78BFA',
            '#C4B5FD',
            '#E0E7FF'
        ],
        borderWidth: 0,
        borderRadius: 8
    }]
};

new Chart(topDeptCtx, {
    type: 'bar',
    data: topDeptData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            x: {
                beginAtZero: true,
                grid: {
                    color: '#f3f4f6'
                }
            },
            y: {
                grid: {
                    display: false
                }
            }
        }
    }
});

// Gráfico de Média Salarial
const salaryCtx = document.getElementById('salaryChart').getContext('2d');
const salaryData = {
    labels: [{% for dept in media_salarios %}'{{ dept.nome }}',{% endfor %}],
    datasets: [{
        label: 'Média Salarial',
        data: [{% for dept in media_salarios %}{{ dept.media_salario|floatformat:2 }},{% endfor %}],
        backgroundColor: '#10B981',
        borderColor: '#059669',
        borderWidth: 2,
        fill: true,
        tension: 0.4
    }]
};

new Chart(salaryCtx, {
    type: 'line',
    data: salaryData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: '#f3f4f6'
                },
                ticks: {
                    callback: function(value) {
                        return 'MZN ' + value.toFixed(2);
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    }
});
</script>
{% endblock %}